// チンチロ計算アプリ v5.3  (初期オーバーレイ常時表示バグ修正)
// 作者: ChatGPT 2025-06-28

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>チンチロ計算アプリ v5.3</title>
<style>
  *{box-sizing:border-box}
  body{font-family:system-ui,sans-serif;margin:14px}
  h2{margin-bottom:14px}
  input,button{font-size:18px;padding:10px 14px;margin:6px 4px}
  button{cursor:pointer;border:none;border-radius:6px;background:#1976d2;color:#fff}
  button:active{opacity:.85}
  .hidden{display:none!important}
  .player-row{border:2px solid #ddd;border-radius:10px;padding:10px;margin-bottom:12px;display:flex;flex-wrap:wrap;align-items:center}
  .player-main{flex:1}
  .parent-tag{background:gold;color:#000;padding:2px 8px;border-radius:4px;font-size:14px;margin-left:6px}
  .balance{font-weight:bold;margin-left:8px}
  .ctrl-set{display:flex;flex-wrap:wrap;margin-top:6px}
  .outcome-btn{padding:8px 10px;margin:4px;font-size:16px;border-radius:6px;background:#e0e0e0;color:#000}
  .selected{background:#43a047!important;color:#fff!important}
  #topControls{margin:14px 0}
  #summaryOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.55);align-items:center;justify-content:center;z-index:999;display:none}
  #summaryOverlay.show{display:flex}
  #summaryOverlay .box{background:#fff;padding:20px;border-radius:12px;width:90%;max-width:420px;text-align:center}
  #leftList{margin-top:12px;font-size:15px;white-space:pre-wrap}
</style>
</head>
<body>
<h2>チンチロ計算アプリ v5.3</h2>

<!-- === セットアップ === -->
<div id="setupStep">
  <label>プレイヤー人数：<input type="number" id="playerCount" value="2" min="2"></label><br><br>
  <button id="toNameStep">次へ (名前入力)</button>
</div>

<!-- === 名前入力 === -->
<div id="nameStep" class="hidden">
  <h3>プレイヤーの名前を入力</h3>
  <div id="nameInputs"></div>
  <button id="startGame">ゲーム開始</button>
</div>

<!-- === ゲームエリア === -->
<div id="gameArea" class="hidden">
  <div id="topControls">
    レート：<input type="number" id="rateInput" value="1000" min="1" style="width:120px;">円
    <button id="updateRate">更新</button>
    <button id="undoBtn" style="background:#9e9e9e">1手戻す</button>
    <button id="addPlayerBtn" style="background:#4caf50">＋追加</button>
    <button id="showLeftBtn" style="background:#795548">退出者</button>
  </div>
  <div id="scoreBoard"></div>
  <button id="calcRound" style="margin-top:16px;width:100%">計算して結果を見る</button>
  <div id="leftList" class="hidden"></div>
</div>

<!-- === ラウンド結果サマリー === -->
<div id="summaryOverlay">
  <div class="box">
    <h3>ラウンド結果</h3>
    <div id="summaryContent" style="text-align:left;white-space:pre-wrap"></div>
    <button id="nextRoundBtn" style="margin-top:14px;width:100%;background:#43a047">次のラウンドへ</button>
  </div>
</div>

<script>
// ===== データ構造 =====
let players=[];
let parentIndex=0;
let history=[];
let lastDeltas=[];
let leftPlayers=[];

const outcomes=[
  {key:'hifumi', label:'ヒフミ', score:0,  mult:-2},
  {key:'0',      label:'0',    score:10, mult:0},
  {key:'1',      label:'1',    score:20, mult:1},
  {key:'2',      label:'2',    score:30, mult:1},
  {key:'3',      label:'3',    score:40, mult:1},
  {key:'4',      label:'4',    score:50, mult:1},
  {key:'5',      label:'5',    score:60, mult:1},
  {key:'6',      label:'6',    score:70, mult:1},
  {key:'shigoro',label:'シゴロ',score:80, mult:2},
  {key:'zorome', label:'ゾロ目',score:90, mult:3},
  {key:'pinzoro',label:'ピンゾロ',score:100,mult:5}
];

// ===== DOM =====
const setupStep=document.getElementById('setupStep');
const nameStep=document.getElementById('nameStep');
const gameArea=document.getElementById('gameArea');
const overlay=document.getElementById('summaryOverlay');
const summaryContent=document.getElementById('summaryContent');

// ===== ステップ遷移 =====
document.getElementById('toNameStep').onclick=()=>{
  const num=parseInt(document.getElementById('playerCount').value);
  if(isNaN(num)||num<2){alert('2人以上入力してください');return;}
  const box=document.getElementById('nameInputs');box.innerHTML='';
  for(let i=0;i<num;i++)box.innerHTML+=`<div><input type="text" id="name${i}" placeholder="プレイヤー${i+1}"></div>`;
  setupStep.classList.add('hidden');nameStep.classList.remove('hidden');
};

document.getElementById('startGame').onclick=()=>{
  const num=parseInt(document.getElementById('playerCount').value);
  players=[];history=[];lastDeltas=[];leftPlayers=[];
  for(let i=0;i<num;i++){
    const n=document.getElementById(`name${i}`).value.trim()||`Player${i+1}`;
    players.push({name:n,balance:0,outcomeKey:null});
  }
  parentIndex=0;
  nameStep.classList.add('hidden');gameArea.classList.remove('hidden');
  renderBoard();
};

// ===== UI描画 =====
function renderBoard(){
  const board=document.getElementById('scoreBoard');board.innerHTML='';
  players.forEach((p,idx)=>{
    const row=document.createElement('div');row.className='player-row';
    // メイン info
    const main=document.createElement('div');main.className='player-main';
    main.innerHTML=`<span>${p.name}</span>${idx===parentIndex?'<span class=\"parent-tag\">親</span>':''}<span class=\"balance\">${p.balance}円</span>`;
    row.appendChild(main);

    const ops=document.createElement('div');ops.style.display='flex';ops.style.flexWrap='wrap';
    // 親
    const pBtn=createBtn('親','#ff9800',()=>{parentIndex=idx;players.forEach(pl=>pl.outcomeKey=null);renderBoard();});
    // 並び替え
    const upBtn=createBtn('↑','#607d8b',()=>{if(idx>0){swap(idx,idx-1);renderBoard();}});
    const downBtn=createBtn('↓','#607d8b',()=>{if(idx<players.length-1){swap(idx,idx+1);renderBoard();}});
    // 退出
    const outBtn=createBtn('抜ける','#9c27b0',()=>{if(confirm(`${p.name} が ${p.balance}円 で退出しますか？`)){leftPlayers.push({name:p.name,final:p.balance});players.splice(idx,1);if(parentIndex>=idx)parentIndex=Math.max(0,parentIndex-1);renderBoard();}});
    [pBtn,upBtn,downBtn,outBtn].forEach(b=>ops.appendChild(b));
    row.appendChild(ops);

    // 役選択
    const panel=document.createElement('div');panel.className='ctrl-set';
    outcomes.forEach(o=>{
      const b=createBtn(o.label,'#e0e0e0',()=>{p.outcomeKey=o.key;renderBoard();});
      if(p.outcomeKey===o.key)b.classList.add('selected');
      panel.appendChild(b);
    });
    row.appendChild(panel);
    board.appendChild(row);
  });
}
function createBtn(text,bg,fn){const b=document.createElement('button');b.textContent=text;b.style.background=bg;b.onclick=fn;return b;}
function swap(a,b){[players[a],players[b]]=[players[b],players[a]];if(parentIndex===a)parentIndex=b;else if(parentIndex===b)parentIndex=a;}

// ===== イベント =====

document.getElementById('addPlayerBtn').onclick=()=>{
  const n=prompt('追加するプレイヤー名を入力');if(!n)return;players.push({name:n.trim(),balance:0,outcomeKey:null});renderBoard();};

document.getElementById('showLeftBtn').onclick=()=>{
  const listDiv=document.getElementById('leftList');
  if(leftPlayers.length===0){alert('退出者はいません');return;}
  let txt='--- 退出メンバー ---\n';leftPlayers.forEach(lp=>{txt+=`${lp.name}：${lp.final}円\n`;});
  listDiv.textContent=txt;listDiv.classList.toggle('hidden');
};

document.getElementById('updateRate').onclick=()=>{
  const r=parseInt(document.getElementById('rateInput').value);if(isNaN(r)||r<=0)alert('正しいレートを入力');};

document.getElementById
