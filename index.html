<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>チンチロ計算アプリ v5.9</title>
  <style>
    :root {
      --main-bg: #1976d2;
      --gray: #9e9e9e;
      --danger: #f44336;
      --success: #4caf50;
      --warning: #ff9800;
      --primary-font: system-ui, sans-serif;
    }
    *{box-sizing:border-box}
    body{font-family:var(--primary-font);margin:14px}
    h2{margin-bottom:14px}
    input,button{font-size:16px;padding:8px 12px;margin:4px}
    button{cursor:pointer;border:none;border-radius:6px;background:var(--main-bg);color:#fff}
    button:active{opacity:.85}
    .hidden{display:none!important}
    .flex{display:flex;flex-wrap:wrap;align-items:center;gap:4px}
    .player-row{border:2px solid #ddd;border-radius:10px;padding:8px;margin-bottom:10px}
    .player-main{flex:1;font-size:15px;font-weight:600}
    .balance{margin-left:6px}
    .parent-tag{background:gold;color:#000;padding:2px 6px;border-radius:4px;margin-left:6px;font-size:12px}
    .parent-highlight{background:var(--warning);color:#fff;box-shadow:0 0 8px rgba(255,152,0,.8);border-color:#f57c00}
    .btn-gray{background:var(--gray)}
    .btn-success{background:var(--success)}
    .btn-danger{background:var(--danger)}
    .btn-warning{background:var(--warning)}
    .btn-primary{background:var(--main-bg)}
    .outcome-btn{background:#e0e0e0;color:#000;padding:6px 10px;font-size:14px;border-radius:6px}
    .outcome-btn.selected{background:var(--success);color:#fff}
    .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:999}
    .overlay.show{display:flex}
    .modal-box{background:#fff;padding:20px;border-radius:12px;width:92%;max-width:500px}
    @media(max-width:480px){input,button{font-size:14px;padding:6px 8px}.player-row{padding:6px}.player-main{font-size:14px}}
  </style>
</head>
<body>
<h2>チンチロ計算アプリ v5.9</h2>
<div id="setupStep"><label>プレイヤー人数：<input type="number" id="playerCount" value="2" min="2" style="width:80px"></label><button id="toNameStep" class="btn-primary">次へ (名前入力)</button></div>
<div id="nameStep" class="hidden"><h3>プレイヤーの名前を入力</h3><div id="nameInputs"></div><button id="startGame" class="btn-success">ゲーム開始</button></div>
<div id="gameArea" class="hidden">
  <div id="topControls" class="flex" style="margin:10px 0">レート：<input type="number" id="rateInput" value="1000" min="1" style="width:100px"><button id="undoBtn" class="btn-gray">1手戻す</button><button id="addPlayerBtn" class="btn-success">＋追加</button><button id="showLeftBtn" class="btn-warning">退出者</button><button id="historyBtn" class="btn-primary">履歴</button><button id="adjustBtn" class="btn-danger">金額調整</button></div>
  <div id="scoreBoard"></div><button id="calcRound" class="btn-primary" style="width:100%;margin-top:12px">計算して結果を見る</button><pre id="leftList" class="hidden"></pre>
</div>
<div id="summaryOverlay" class="overlay"><div class="modal-box" style="max-width:420px;text-align:center"><h3>ラウンド結果</h3><pre id="summaryContent" style="text-align:left;white-space:pre-wrap"></pre><button id="nextRoundBtn" class="btn-success" style="width:100%">次のラウンドへ</button></div></div>
<div id="modalContainer"></div>
<script>
/************ ヘルパ *************/
const $=(s,b=document)=>b.querySelector(s);
const $$=(s,b=document)=>[...b.querySelectorAll(s)];
const create=(t,p={})=>Object.assign(document.createElement(t),p);
const btn=(txt,cls,fn)=>Object.assign(create('button',{textContent:txt}),{className:cls,onclick:fn});
const swap=(arr,i,j)=>([arr[i],arr[j]]=[arr[j],arr[i]]);
const intVal=sel=>parseInt($(sel).value,10);
/************ データ *************/
let players=[],parentIndex=0,historyStack=[],leftPlayers=[],gameHistory=[];
const outcomes=[['hifumi','ヒフミ',0,-2],['0','0',10,0],['1','1',20,1],['2','2',30,1],['3','3',40,1],['4','4',50,1],['5','5',60,1],['6','6',70,1],['shigoro','シゴロ',80,2],['arashi','アラシ',90,3],['pinzoro','ピンゾロ',100,5]].map(([k,l,s,m])=>({key:k,label:l,score:s,mult:m}));
/************ ボード描画 *************/
function renderBoard(){const board=$('#scoreBoard');board.textContent='';players.forEach((p,i)=>{const row=create('div',{className:player-row ${i===parentIndex?'parent-highlight':''}});const main=create('div',{className:'player-main',innerHTML:${p.name}${i===parentIndex?'<span class="parent-tag">親</span>':''}<span class="balance">${p.balance}ソシー</span>});row.appendChild(main);
  const ops=create('div',{className:'flex'});
  ops.appendChild(btn('親','btn-warning',()=>{parentIndex=i;players.forEach(pl=>pl.outcome=null);renderBoard();}));
  ops.appendChild(btn('↑','btn-gray',()=>{if(i>0){swap(players,i,i-1);if(parentIndex===i)parentIndex--;else if(parentIndex===i-1)parentIndex++;renderBoard();}}));
  ops.appendChild(btn('↓','btn-gray',()=>{if(i<players.length-1){swap(players,i,i+1);if(parentIndex===i)parentIndex++;else if(parentIndex===i+1)parentIndex--;renderBoard();}}));
  row.appendChild(ops);
  const panel=create('div',{className:'flex',style:'margin-top:6px'});
  outcomes.forEach(o=>{const b=btn(o.label,'outcome-btn',()=>{p.outcome=o;renderBoard();});if(p.outcome?.key===o.key)b.classList.add('selected');panel.appendChild(b);});
  row.appendChild(panel);board.appendChild(row);});
  updateLeftDisplay();}
/************ 画面遷移 *************/
$('#toNameStep').onclick=()=>{const n=intVal('#playerCount');if(n<2||isNaN(n))return alert('2人以上入力してください');const box=$('#nameInputs');box.textContent='';[...Array(n)].forEach((_,i)=>box.appendChild(create('input',{id:name${i},placeholder:プレイヤー${i+1},style:'display:block;margin:6px 0;padding:6px;border:1px solid #ccc'})));$('#setupStep').classList.add('hidden');$('#nameStep').classList.remove('hidden');};
$('#startGame').onclick=()=>{const n=intVal('#playerCount');players=[...Array(n)].map((_,i)=>({name:$('#name'+i).value.trim()||Player${i+1},balance:0}));parentIndex=0;historyStack=[];gameHistory=[];$('#nameStep').classList.add('hidden');$('#gameArea').classList.remove('hidden');renderBoard();};
/************ 対戦ロジック *************/
function calcBattle(po,co,r){if(po.key===co.key)return['parent',r*po.mult,'同役で親勝ち'];if(po.key==='hifumi'||co.key==='hifumi'){const mult=(po.key==='hifumi'?co:po).mult*2;return[po.key==='hifumi'?'child':'parent',r*mult,'ヒフミ倍付け'];}const win=po.score>co.score?'parent':'child';const mult=(win==='parent'?po:co).mult;return[win,r*mult,${mult}倍];}
$('#calcRound').onclick=()=>{const rate=intVal('#rateInput');if(rate<=0||isNaN(rate))return alert('正しいレートを入力');const unselected=players.filter(p=>!p.outcome);if(unselected.length)return alert(unselected.map(p=>p.name).join(', ')+' の役が未選択');historyStack.push(JSON.parse(JSON.stringify({players,parentIndex})));const parent=players[parentIndex];let log=親: ${parent.name} (${parent.outcome.label})\n\n;
  players.forEach((p,i)=>{if(i===parentIndex)return;const[w,amt,reason]=calcBattle(parent.outcome,p.outcome,rate);if(w==='parent'){p.balance-=amt;parent.balance+=amt;}else{p.balance+=amt;parent.balance-=amt;}log+=${p.name} ${w==='parent'?'-':'+'}${amt}ソシー (${reason})\n;});
  log+=\n親 ${parent.name}: ${parent.balance}ソシー;
  $('#summaryContent').textContent=log;
  gameHistory.push(【${new Date().toLocaleString('ja-JP')}】\n${log}\n${'='.repeat(40)}\n);
  $('#summaryOverlay').classList.add('show');
  renderBoard();};
$('#nextRoundBtn').onclick=()=>{players.forEach(p=>p.outcome=null);parentIndex=(parentIndex+1)%players.length;$('#summaryOverlay').classList.remove('show');renderBoard();};
$('#undoBtn').onclick=()=>{if(!historyStack.length)return alert('戻す履歴がありません');({players,parentIndex}=historyStack.pop());renderBoard();alert('1手戻しました');};
/************ 共通オーバーレイ *************/
function overlay(){const ov=create('div',{className:'overlay show'});ov.onclick=e=>e.target===ov&&ov.remove();$('#modalContainer').appendChild(ov);return ov;}
/************ プレイヤー追加 *************/
$('#addPlayerBtn').onclick=()=>addPlayerModal();
function addPlayerModal(){const ov=overlay();const box=create('div',{className:'modal-box'});ov.appendChild(box);box.innerHTML='<h3>新しいプレイヤーを追加</h3>';
  const input=create('input',{id:'newName',placeholder:'プレイヤー名',style:'width:100%;margin:10px 0;padding:8px;border:1px solid #ccc'});box.appendChild(input);
  const foot=create('div',{className:'flex',style:'justify-content:center'});
  foot.appendChild(btn('キャンセル','btn-gray',()=>ov.remove()));
  foot.appendChild(btn('追加','btn-success',()=>{
    const name=input.value.trim();if(!name)return alert('名前を入力');const idx=leftPlayers.findIndex(p=>p.name===name);
    if(idx!==-1){players.push({name:leftPlayers[idx].name,balance:leftPlayers[idx].final});leftPlayers.splice(idx,1);alert(name+' が復活');}
    else{players.push({name,balance:0});}
    renderBoard();ov.remove();
  }));
  box.appendChild(foot);
  input.focus();}
/************ 退出 *************/
$('#showLeftBtn').onclick=()=>players.length?exitModal():alert('プレイヤーがいません');
function exitModal(){const ov=overlay();const box=create('div',{className:'modal-box'});ov.appendChild(box);box.appendChild(create('h3',{textContent:'退出するプレイヤーを選択'}));
  players.forEach((p,i)=>{const div=create('div',{textContent:${p.name} (${p.balance}ソシー),className:'player-row',style:'cursor:pointer'});div.onclick=()=>{players.splice(i,1);leftPlayers.push({name:p.name,final:p.balance});if(parentIndex>=i)parentIndex=Math.max(0,parentIndex-1);renderBoard();ov.remove();alert(p.name+' を退出');};box.appendChild(div);});
  box.appendChild(btn('閉じる','btn-gray',()=>ov.remove()));}
/************ 履歴 *************/
$('#historyBtn').onclick=()=>historyModal();
function historyModal(){const ov=overlay();const box=create('div',{className:'modal-box',style:'max-width:600px;max-height:80vh;overflow-y:auto'});ov.appendChild(box);
  box.appendChild(create('h3',{textContent:'履歴'}));
  const pre=create('pre',{textContent:gameHistory.length?gameHistory.join('\n'):'履歴がありません',style:'border:1px solid #ddd;padding:8px;white-space:pre-wrap'});
  box.appendChild(pre);
  const foot=create('div',{className:'flex',style:'justify-content:center'});
  foot.append　
