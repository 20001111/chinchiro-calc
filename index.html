<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ³ãƒãƒ­è¨ˆç®—ã‚¢ãƒ—ãƒª v6.0</title>
  <style>
    :root {
      --main-bg: #1976d2;
      --gray: #9e9e9e;
      --danger: #f44336;
      --success: #4caf50;
      --warning: #ff9800;
      --font: system-ui, sans-serif;
    }
    * { box-sizing: border-box; }
    body { font-family: var(--font); margin: 14px; background: #f5f5f5; }
    h2 { margin-bottom: 14px; color: var(--main-bg); }
    input, button { font-size: 16px; padding: 8px 12px; margin: 4px; border: 1px solid #ddd; border-radius: 6px; }
    button { cursor: pointer; border: none; background: var(--main-bg); color: #fff; transition: all 0.2s; }
    button:hover { opacity: 0.9; transform: translateY(-1px); }
    button:active { opacity: 0.8; transform: translateY(0); }
    .hidden { display: none !important; }
    .flex { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; }
    .player-row { 
      border: 2px solid #ddd; 
      border-radius: 12px; 
      padding: 12px; 
      margin-bottom: 10px; 
      background: #fff; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .player-main { flex: 1; font-size: 16px; font-weight: 600; }
    .balance { margin-left: 8px; color: var(--main-bg); }
    .parent-tag { 
      background: linear-gradient(45deg, gold, #ffd700); 
      color: #000; 
      padding: 4px 8px; 
      border-radius: 12px; 
      margin-left: 8px; 
      font-size: 12px; 
      font-weight: bold;
    }
    .parent-highlight { 
      background: linear-gradient(135deg, #fff3e0, #ffe0b2); 
      border-color: var(--warning); 
      box-shadow: 0 0 12px rgba(255,152,0,0.3); 
    }
    .btn-gray { background: var(--gray); }
    .btn-success { background: var(--success); }
    .btn-danger { background: var(--danger); }
    .btn-warning { background: var(--warning); }
    .btn-primary { background: var(--main-bg); }
    .outcome-btn { 
      background: #e0e0e0; 
      color: #000; 
      padding: 8px 12px; 
      font-size: 14px; 
      border-radius: 8px; 
      min-width: 60px;
    }
    .outcome-btn.selected { background: var(--success); color: #fff; box-shadow: 0 2px 8px rgba(76,175,80,0.4); }
    .overlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.6); 
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 999; 
    }
    .overlay.show { display: flex; }
    .modal-box { 
      background: #fff; 
      padding: 24px; 
      border-radius: 16px; 
      width: 92%; 
      max-width: 500px; 
      max-height: 80vh; 
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .stats { background: #e3f2fd; padding: 12px; border-radius: 8px; margin: 10px 0; }
    @media(max-width:480px) {
      input, button { font-size: 14px; padding: 6px 8px; }
      .player-row { padding: 8px; }
      .player-main { font-size: 14px; }
    }
  </style>
</head>
<body>

<h2>ğŸ² ãƒãƒ³ãƒãƒ­è¨ˆç®—ã‚¢ãƒ—ãƒª v6.0</h2>

<!-- ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ -->
<div id="setupStep">
  <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äººæ•°ï¼š
    <input type="number" id="playerCount" value="2" min="2" max="8" style="width:80px">
  </label>
  <button id="toNameStep" class="btn-primary">æ¬¡ã¸ (åå‰å…¥åŠ›)</button>
</div>

<!-- åå‰å…¥åŠ›ç”»é¢ -->
<div id="nameStep" class="hidden">
  <h3>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åå‰ã‚’å…¥åŠ›</h3>
  <div id="nameInputs"></div>
  <button id="startGame" class="btn-success">ğŸ® ã‚²ãƒ¼ãƒ é–‹å§‹</button>
</div>

<!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
<div id="gameArea" class="hidden">
  <div class="stats">
    <div class="flex">
      ãƒ¬ãƒ¼ãƒˆï¼š<input type="number" id="rateInput" value="1000" min="1" style="width:100px">
      <span>ãƒ©ã‚¦ãƒ³ãƒ‰: <span id="roundCounter">1</span></span>
    </div>
  </div>
  
  <div id="topControls" class="flex" style="margin:10px 0">
    <button id="undoBtn" class="btn-gray">âª æˆ»ã™</button>
    <button id="addPlayerBtn" class="btn-success">â• è¿½åŠ </button>
    <button id="showLeftBtn" class="btn-warning">ğŸ‘‹ é€€å‡ºè€…</button>
    <button id="historyBtn" class="btn-primary">ğŸ“œ å±¥æ­´</button>
    <button id="adjustBtn" class="btn-danger">ğŸ’° èª¿æ•´</button>
    <button id="resetBtn" class="btn-gray">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
  </div>
  
  <div id="scoreBoard"></div>
  
  <button id="calcRound" class="btn-primary" style="width:100%;margin-top:12px;font-size:18px">
    ğŸ¯ è¨ˆç®—ã—ã¦çµæœã‚’è¦‹ã‚‹
  </button>

  <div id="leftList" class="hidden"></div>
</div>

<!-- çµæœè¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="summaryOverlay" class="overlay">
  <div class="modal-box" style="max-width:420px;text-align:center">
    <h3>ğŸŠ ãƒ©ã‚¦ãƒ³ãƒ‰çµæœ</h3>
    <pre id="summaryContent" style="text-align:left;white-space:pre-wrap;background:#f5f5f5;padding:12px;border-radius:8px"></pre>
    <button id="nextRoundBtn" class="btn-success" style="width:100%">â¡ï¸ æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸</button>
  </div>
</div>

<div id="modalContainer"></div>

<script>
// ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
const $ = (s, b = document) => b.querySelector(s);
const $$ = (s, b = document) => [...b.querySelectorAll(s)];
const create = (t, p = {}) => Object.assign(document.createElement(t), p);
const btn = (txt, cls, fn) => Object.assign(create('button', {textContent: txt}), {className: cls, onclick: fn});
const swap = (arr, i, j) => ([arr[i], arr[j]] = [arr[j], arr[i]]);
const intVal = sel => parseInt($(sel).value, 10);

// ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿
let players = [], parentIndex = 0, historyStack = [], leftPlayers = [], gameHistory = [], roundCounter = 1;

// å½¹ã®å®šç¾©ï¼ˆã‚­ãƒ¼ã€è¡¨ç¤ºåã€ã‚¹ã‚³ã‚¢ã€å€ç‡ï¼‰
const outcomes = [
  ['hifumi', 'ãƒ’ãƒ•ãƒŸ', 0, -2],
  ['0', '0', 10, 0],
  ['1', '1', 20, 1],
  ['2', '2', 30, 1],
  ['3', '3', 40, 1],
  ['4', '4', 50, 1],
  ['5', '5', 60, 1],
  ['6', '6', 70, 1],
  ['shigoro', 'ã‚·ã‚´ãƒ­', 80, 2],
  ['arashi', 'ã‚¢ãƒ©ã‚·', 90, 3],
  ['pinzoro', 'ãƒ”ãƒ³ã‚¾ãƒ­', 100, 5]
].map(([key, label, score, mult]) => ({key, label, score, mult}));

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒœãƒ¼ãƒ‰æç”»
function renderBoard() {
  const board = $('#scoreBoard');
  board.innerHTML = '';
  
  players.forEach((player, i) => {
    const row = create('div', {className: `player-row ${i === parentIndex ? 'parent-highlight' : ''}`});
    
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±
    const main = create('div', {
      className: 'player-main',
      innerHTML: `${player.name}${i === parentIndex ? '<span class="parent-tag">è¦ª</span>' : ''}<span class="balance">${player.balance}ã‚½ã‚·ãƒ¼</span>`
    });
    row.appendChild(main);
    
    // æ“ä½œãƒœã‚¿ãƒ³
    const ops = create('div', {className: 'flex'});
    ops.appendChild(btn('è¦ª', 'btn-warning', () => {
      parentIndex = i;
      players.forEach(p => p.outcome = null);
      renderBoard();
    }));
    ops.appendChild(btn('â†‘', 'btn-gray', () => {
      if (i > 0) {
        swap(players, i, i - 1);
        if (parentIndex === i) parentIndex--;
        else if (parentIndex === i - 1) parentIndex++;
        renderBoard();
      }
    }));
    ops.appendChild(btn('â†“', 'btn-gray', () => {
      if (i < players.length - 1) {
        swap(players, i, i + 1);
        if (parentIndex === i) parentIndex++;
        else if (parentIndex === i + 1) parentIndex--;
        renderBoard();
      }
    }));
    row.appendChild(ops);
    
    // å½¹é¸æŠãƒœã‚¿ãƒ³
    const panel = create('div', {className: 'flex', style: 'margin-top:8px'});
    outcomes.forEach(outcome => {
      const b = btn(outcome.label, 'outcome-btn', () => {
        player.outcome = outcome;
        renderBoard();
      });
      if (player.outcome?.key === outcome.key) b.classList.add('selected');
      panel.appendChild(b);
    });
    row.appendChild(panel);
    board.appendChild(row);
  });
  
  updateLeftDisplay();
}

// ç”»é¢é·ç§»
$('#toNameStep').onclick = () => {
  const n = intVal('#playerCount');
  if (n < 2 || isNaN(n)) return alert('2äººä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„');
  
  const box = $('#nameInputs');
  box.innerHTML = '';
  [...Array(n)].forEach((_, i) => {
    box.appendChild(create('input', {
      id: `name${i}`,
      placeholder: `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i + 1}`,
      style: 'display:block;margin:6px 0;padding:8px;border:1px solid #ccc;border-radius:6px'
    }));
  });
  
  $('#setupStep').classList.add('hidden');
  $('#nameStep').classList.remove('hidden');
};

$('#startGame').onclick = () => {
  const n = intVal('#playerCount');
  players = [...Array(n)].map((_, i) => ({
    name: $(`#name${i}`).value.trim() || `Player${i + 1}`,
    balance: 0
  }));
  
  parentIndex = 0;
  historyStack = [];
  gameHistory = [];
  roundCounter = 1;
  
  $('#nameStep').classList.add('hidden');
  $('#gameArea').classList.remove('hidden');
  renderBoard();
};

// å¯¾æˆ¦è¨ˆç®—
function calcBattle(parentOutcome, childOutcome, rate) {
  if (parentOutcome.key === childOutcome.key) {
    return ['parent', rate * parentOutcome.mult, 'åŒå½¹ã§è¦ªå‹ã¡'];
  }
  
  if (parentOutcome.key === 'hifumi' || childOutcome.key === 'hifumi') {
    const mult = (parentOutcome.key === 'hifumi' ? childOutcome : parentOutcome).mult * 2;
    return [parentOutcome.key === 'hifumi' ? 'child' : 'parent', rate * mult, 'ãƒ’ãƒ•ãƒŸå€ä»˜ã‘'];
  }
  
  const winner = parentOutcome.score > childOutcome.score ? 'parent' : 'child';
  const mult = (winner === 'parent' ? parentOutcome : childOutcome).mult;
  return [winner, rate * mult, `${mult}å€`];
}

// ãƒ©ã‚¦ãƒ³ãƒ‰è¨ˆç®—
$('#calcRound').onclick = () => {
  const rate = intVal('#rateInput');
  if (rate <= 0 || isNaN(rate)) return alert('æ­£ã—ã„ãƒ¬ãƒ¼ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  
  const unselected = players.filter(p => !p.outcome);
  if (unselected.length) {
    return alert(unselected.map(p => p.name).join(', ') + ' ã®å½¹ãŒæœªé¸æŠã§ã™');
  }
  
  // å±¥æ­´ä¿å­˜
  historyStack.push(JSON.parse(JSON.stringify({players, parentIndex, roundCounter})));
  
  const parent = players[parentIndex];
  let log = `ãƒ©ã‚¦ãƒ³ãƒ‰ ${roundCounter}\nè¦ª: ${parent.name} (${parent.outcome.label})\n\n`;
  
  players.forEach((player, i) => {
    if (i === parentIndex) return;
    
    const [winner, amount, reason] = calcBattle(parent.outcome, player.outcome, rate);
    if (winner === 'parent') {
      player.balance -= amount;
      parent.balance += amount;
    } else {
      player.balance += amount;
      parent.balance -= amount;
    }
    
    log += `${player.name} ${winner === 'parent' ? '-' : '+'}${amount}ã‚½ã‚·ãƒ¼ (${reason})\n`;
  });
  
  log += `\nç¾åœ¨ã®æ®‹é«˜:\n`;
  players.forEach(p => log += `${p.name}: ${p.balance}ã‚½ã‚·ãƒ¼\n`);
  
  $('#summaryContent').textContent = log;
  gameHistory.push(`ã€${new Date().toLocaleString('ja-JP')}ã€‘\n${log}\n${'='.repeat(40)}\n`);
  $('#summaryOverlay').classList.add('show');
  renderBoard();
};

// æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰
$('#nextRoundBtn').onclick = () => {
  players.forEach(p => p.outcome = null);
  parentIndex = (parentIndex + 1) % players.length;
  roundCounter++;
  $('#roundCounter').textContent = roundCounter;
  $('#summaryOverlay').classList.remove('show');
  renderBoard();
};

// 1æ‰‹æˆ»ã™
$('#undoBtn').onclick = () => {
  if (!historyStack.length) return alert('æˆ»ã™å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“');
  
  const state = historyStack.pop();
  players = state.players;
  parentIndex = state.parentIndex;
  roundCounter = state.roundCounter;
  $('#roundCounter').textContent = roundCounter;
  renderBoard();
  alert('1æ‰‹æˆ»ã—ã¾ã—ãŸ');
};

// å…±é€šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ä½œæˆ
function createOverlay() {
  const overlay = create('div', {className: 'overlay show'});
  overlay.onclick = e => e.target === overlay && overlay.remove();
  $('#modalContainer').appendChild(overlay);
  return overlay;
}

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ 
$('#addPlayerBtn').onclick = () => {
  const overlay = createOverlay();
  const box = create('div', {className: 'modal-box'});
  overlay.appendChild(box);
  
  box.innerHTML = '<h3>æ–°ã—ã„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ </h3>';
  
  const input = create('input', {
    placeholder: 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å',
    style: 'width:100%;margin:10px 0;padding:8px;border:1px solid #ccc;border-radius:6px'
  });
  box.appendChild(input);
  
  const footer = create('div', {className: 'flex', style: 'justify-content:center'});
  footer.appendChild(btn('ã‚­ãƒ£ãƒ³ã‚»ãƒ«', 'btn-gray', () => overlay.remove()));
  footer.appendChild(btn('è¿½åŠ ', 'btn-success', () => {
    const name = input.value.trim();
    if (!name) return alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    
    const leftIndex = leftPlayers.findIndex(p => p.name === name);
    if (leftIndex !== -1) {
      players.push({name: leftPlayers[leftIndex].name, balance: leftPlayers[leftIndex].final});
      leftPlayers.splice(leftIndex, 1);
      alert(`${name} ãŒå¾©æ´»ã—ã¾ã—ãŸ`);
    } else {
      players.push({name, balance: 0});
    }
    
    renderBoard();
    overlay.remove();
  }));
  box.appendChild(footer);
  input.focus();
};

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é€€å‡º
$('#showLeftBtn').onclick = () => {
  if (!players.length) return alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ã¾ã›ã‚“');
  
  const overlay = createOverlay();
  const box = create('div', {className: 'modal-box'});
  overlay.appendChild(box);
  
  box.appendChild(create('h3', {textContent: 'é€€å‡ºã™ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸æŠ'}));
  
  players.forEach((player, i) => {
    const div = create('div', {
      textContent: `${player.name} (${player.balance}ã‚½ã‚·ãƒ¼)`,
      className: 'player-row',
      style: 'cursor:pointer;margin:5px 0'
    });
    div.onclick = () => {
      players.splice(i, 1);
      leftPlayers.push({name: player.name, final: player.balance});
      if (parentIndex >= i) parentIndex = Math.max(0, parentIndex - 1);
      renderBoard();
      overlay.remove();
      alert(`${player.name} ã‚’é€€å‡ºã•ã›ã¾ã—ãŸ`);
    };
    box.appendChild(div);
  });
  
  box.appendChild(btn('é–‰ã˜ã‚‹', 'btn-gray', () => overlay.remove()));
};

// å±¥æ­´è¡¨ç¤º
$('#historyBtn').onclick = () => {
  const overlay = createOverlay();
  const box = create('div', {className: 'modal-box', style: 'max-width:600px'});
  overlay.appendChild(box);
  
  box.appendChild(create('h3', {textContent: 'ã‚²ãƒ¼ãƒ å±¥æ­´'}));
  
  const pre = create('pre', {
    textContent: gameHistory.length ? gameHistory.join('\n') : 'å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“',
    style: 'border:1px solid #ddd;padding:12px;white-space:pre-wrap;background:#f9f9f9;border-radius:8px'
  });
  box.appendChild(pre);
  
  const footer = create('div', {className: 'flex', style: 'justify-content:center'});
  footer.appendChild(btn('å±¥æ­´ã‚¯ãƒªã‚¢', 'btn-danger', () => {
    if (confirm('å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
      gameHistory = [];
      pre.textContent = 'å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“';
    }
  }));
  footer.appendChild(btn('é–‰ã˜ã‚‹', 'btn-gray', () => overlay.remove()));
  box.appendChild(footer);
};

// é‡‘é¡èª¿æ•´
$('#adjustBtn').onclick = () => {
  const overlay = createOverlay();
  const box = create('div', {className: 'modal-box'});
  overlay.appendChild(box);
  
  box.appendChild(create('h3', {textContent: 'é‡‘é¡èª¿æ•´'}));
  
  players.forEach((player, i) => {
    const div = create('div', {className: 'flex', style: 'margin:8px 0;align-items:center'});
    div.appendChild(create('span', {textContent: `${player.name}: `, style: 'min-width:100px'}));
    const input = create('input', {
      type: 'number',
      value: player.balance,
      style: 'flex:1;margin:0 8px'
    });
    div.appendChild(input);
    div.appendChild(btn('æ›´æ–°', 'btn-primary', () => {
      player.balance = parseInt(input.value) || 0;
      renderBoard();
    }));
    box.appendChild(div);
  });
  
  box.appendChild(btn('é–‰ã˜ã‚‹', 'btn-gray', () => overlay.remove()));
};

// ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
$('#resetBtn').onclick = () => {
  if (confirm('ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆå»ã•ã‚Œã¾ã™ã€‚')) {
    players.forEach(p => p.balance = 0);
    historyStack = [];
    gameHistory = [];
    leftPlayers = [];
    roundCounter = 1;
    $('#roundCounter').textContent = roundCounter;
    renderBoard();
    alert('ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
  }
};

// é€€å‡ºè€…ãƒªã‚¹ãƒˆæ›´æ–°
function updateLeftDisplay() {
  const leftList = $('#leftList');
  if (leftPlayers.length === 0) {
    leftList.classList.add('hidden');
  } else {
    leftList.classList.remove('hidden');
    leftList.textContent = 'é€€å‡ºè€…:\n' + leftPlayers.map(p => `${p.name}: ${p.final}ã‚½ã‚·ãƒ¼`).join('\n');
  }
}
</script>

</body>
</html>
